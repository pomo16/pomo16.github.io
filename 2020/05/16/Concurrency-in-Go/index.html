<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.8.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>Concurrency in Go | Atlantis</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/8.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Concurrency in Go</h1><a id="logo" href="/.">Atlantis</a><p class="description">pomo16的博客</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/toolbox/"><i class="fa fa-book"> 工具箱</i></a><a href="/community/"><i class="fa fa-comments"> 常用社区</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Concurrency in Go</h1><div class="post-meta">May 16, 2020<span> | </span><span class="category"><a href="/categories/go/">go</a></span><span class="post-time"><span class="post-meta-item-text"> | </span><span class="post-meta-item-icon"><i class="fa fa-keyboard-o"></i><span class="post-count"> 2.4k</span><span class="post-meta-item-text"> 字</span></span></span><span class="post-time"> | <span class="post-meta-item-icon"><i class="fa fa-hourglass-half"></i><span class="post-count"> 15</span><span class="post-meta-item-text"> 分钟</span></span></span></div><div class="post-content"><h2 id="1-Why-Use-Concurrency？"><a href="#1-Why-Use-Concurrency？" class="headerlink" title="1. Why Use Concurrency？"></a>1. Why Use Concurrency？</h2><h3 id="1-1-Parallel-Execution"><a href="#1-1-Parallel-Execution" class="headerlink" title="1.1 Parallel Execution"></a>1.1 Parallel Execution</h3><ul>
<li>Two programs execute in parallel if they <strong>execute at exactly the same time</strong></li>
<li>At time t, an instruction is being performed for both P1 and P2</li>
<li>Need replicated hardware</li>
<li>Why Use Parallel Execution？<ul>
<li>Tasks may complete more quickly</li>
<li>Some tasks must be performed sequentially</li>
<li>But some tasks are parallelizable and some are not</li>
</ul>
</li>
</ul>
<h3 id="1-2-Von-Neumann-Bottleneck"><a href="#1-2-Von-Neumann-Bottleneck" class="headerlink" title="1.2 Von Neumann Bottleneck"></a>1.2 Von Neumann Bottleneck</h3><h5 id="Speedup-without-Parallelism"><a href="#Speedup-without-Parallelism" class="headerlink" title="Speedup without Parallelism"></a>Speedup without Parallelism</h5><ul>
<li>Can we achieve speedup without Parallelism？</li>
<li>Design faster processors<ul>
<li>Get speedup without changing software</li>
</ul>
</li>
<li>Design processor with more memory<ul>
<li>Reduces the Von Neumann Bottleneck</li>
<li>Cache access time = 1 clock cycle</li>
<li>Main memory access time = ~100 clock cycles</li>
<li>Increasing on-chip cache improves performance</li>
</ul>
</li>
</ul>
<h5 id="Moore’s-Law"><a href="#Moore’s-Law" class="headerlink" title="Moore’s Law"></a>Moore’s Law</h5><ul>
<li>Predicted that transistor density would double every two years</li>
<li>Smaller transistors switch faster</li>
<li>Not a physical law, just an observation</li>
<li>Exponential increase in density would lead to exponential increase in speed</li>
</ul>
<h3 id="1-3-Power-wall"><a href="#1-3-Power-wall" class="headerlink" title="1.3 Power wall"></a>1.3 Power wall</h3><h5 id="Power-Temperature-Problem"><a href="#Power-Temperature-Problem" class="headerlink" title="Power/Temperature Problem"></a>Power/Temperature Problem</h5><ul>
<li>Transistors consume power when they switch</li>
<li>Increasing transistor density leads to increased power consumption<ul>
<li>Smaller transistors use less power, but density scaling is much faster</li>
</ul>
</li>
<li>High power leads to high temperature</li>
<li>Air cooling(fans) can only remove so much heat</li>
</ul>
<h5 id="Dynamic-Power"><a href="#Dynamic-Power" class="headerlink" title="Dynamic Power"></a>Dynamic Power</h5><ul>
<li>P = α * CFV<sup>2</sup></li>
<li>α is percent of time switching</li>
<li>C is capacitance(related to size)</li>
<li>F is the clock frequency</li>
<li>V is voltage swing（from low to high）<ul>
<li>Voltage is important</li>
<li>0 to 5V uses much more power than 0 to 1.3V</li>
</ul>
</li>
</ul>
<h5 id="Dennard-Scaling"><a href="#Dennard-Scaling" class="headerlink" title="Dennard Scaling"></a>Dennard Scaling</h5><ul>
<li><p><strong>Voltage should scale</strong> with transistor size</p>
</li>
<li><p>Keeps power consumption and temperature low</p>
</li>
<li>Problem: Voltage can’t go too low<ul>
<li>Must stay above threshold voltage </li>
<li>Noise problems occur</li>
</ul>
</li>
<li>Problem: Doesn’t consider leakage power</li>
<li>Dennard scaling must stop</li>
</ul>
<h5 id="Multi-Core-Systems"><a href="#Multi-Core-Systems" class="headerlink" title="Multi-Core Systems"></a>Multi-Core Systems</h5><ul>
<li>P = α * CFV<sup>2</sup></li>
<li>Cannot increase frequency</li>
<li>Can still add processor cores, without increasing frequency<ul>
<li>Trend is apparent today</li>
</ul>
</li>
<li>Parallel execution is needed to exploit multi-core systems</li>
<li>Code made to execute on multiple cores</li>
<li>Different programs on different cores</li>
</ul>
<h3 id="1-4-Concurrent-vs-Parallel"><a href="#1-4-Concurrent-vs-Parallel" class="headerlink" title="1.4 Concurrent vs Parallel"></a>1.4 Concurrent vs Parallel</h3><h5 id="Concurrent-execution"><a href="#Concurrent-execution" class="headerlink" title="Concurrent execution"></a>Concurrent execution</h5><ul>
<li>Concurrent execution is not necessarily the same as parallel execution</li>
<li><strong>Concurrent: start and end times overlap</strong></li>
<li><strong>Parallel: execute at exactly the same time</strong></li>
</ul>
<p><img src="https://pomo-blog.oss-cn-shenzhen.aliyuncs.com/article/285.png" style="zoom:50%;"></p>
<ul>
<li>Parallel tasks must be executed on different hardware</li>
<li>Concurrent tasks may be executed on the same hardware<ul>
<li>Only one task actually executed at a time</li>
</ul>
</li>
<li>Mapping from tasks to hardware is not directly controlled by the programmer<ul>
<li>At least not in go</li>
</ul>
</li>
</ul>
<h3 id="1-5-Concurrent-Programming"><a href="#1-5-Concurrent-Programming" class="headerlink" title="1.5 Concurrent Programming"></a>1.5 Concurrent Programming</h3><ul>
<li>Programmer determines which tasks can be executed in parallel</li>
<li>Mapping tasks to hardware<ul>
<li>Operating system</li>
<li>Go runtime schedule</li>
</ul>
</li>
</ul>
<h5 id="Benefit-1-Hiding-Latency"><a href="#Benefit-1-Hiding-Latency" class="headerlink" title="Benefit 1: Hiding Latency"></a>Benefit 1: Hiding Latency</h5><ul>
<li>Concurrency improves performance, even without parallelism</li>
<li>Tasks must <strong>periodically wait</strong> for something<ul>
<li>i.e. wait for memory</li>
<li>X = Y + Z  read Y, Z from memory</li>
<li>May wait 100+ clock cycles</li>
</ul>
</li>
<li>Other concurrent tasks can operate while one task is waiting</li>
</ul>
<h5 id="Benefit-2-Hardware-Mapping"><a href="#Benefit-2-Hardware-Mapping" class="headerlink" title="Benefit 2: Hardware Mapping"></a>Benefit 2: Hardware Mapping</h5><p><img src="https://pomo-blog.oss-cn-shenzhen.aliyuncs.com/article/286.png" style="zoom: 25%;"></p>
<p><strong>Hardware Mapping in Go:</strong></p>
<ul>
<li>Programmer does not determine the hardware mapping</li>
<li>Programmer makes parallelism possible</li>
<li>Hardware mapping depends on many factors<ul>
<li>Where is the data?</li>
<li>What are the communication costs?</li>
</ul>
</li>
</ul>
<p><img src="https://pomo-blog.oss-cn-shenzhen.aliyuncs.com/article/287.png" style="zoom: 33%;"></p>
<h2 id="2-Concurrency-Basics"><a href="#2-Concurrency-Basics" class="headerlink" title="2. Concurrency Basics"></a>2. Concurrency Basics</h2><h3 id="2-1-Processes"><a href="#2-1-Processes" class="headerlink" title="2.1 Processes"></a>2.1 Processes</h3><ul>
<li>An instance of a running program</li>
<li>Things unique to a process<ul>
<li>Memory<ul>
<li>Virtual address space</li>
<li>Code, stack, heap, shared libraries</li>
</ul>
</li>
<li>Registers<ul>
<li>Program counter, data regs, stack ptr, …</li>
</ul>
</li>
</ul>
</li>
</ul>
<h5 id="Operating-Systems"><a href="#Operating-Systems" class="headerlink" title="Operating Systems"></a>Operating Systems</h5><ul>
<li>Allows many processes to execute concurrently</li>
<li>Processes are switched quickly (20ms)</li>
<li>User has the impression of parallelism </li>
<li>Operating system must give processes fair access to resources</li>
</ul>
<h3 id="2-2-Scheduling"><a href="#2-2-Scheduling" class="headerlink" title="2.2 Scheduling"></a>2.2 Scheduling</h3><h5 id="Scheduling-Processes"><a href="#Scheduling-Processes" class="headerlink" title="Scheduling Processes"></a>Scheduling Processes</h5><ul>
<li>Operating system schedules processes for execution</li>
<li>Gives the illusion of parallel execution</li>
</ul>
<p><img src="https://pomo-blog.oss-cn-shenzhen.aliyuncs.com/article/288.png" style="zoom: 33%;"></p>
<ul>
<li>OS gives fair access to CPU, memory, etc.</li>
</ul>
<h5 id="Context-Switch"><a href="#Context-Switch" class="headerlink" title="Context Switch"></a>Context Switch</h5><ul>
<li><p>Control flow changes from one process to another</p>
<p><img src="https://pomo-blog.oss-cn-shenzhen.aliyuncs.com/article/289.png" style="zoom: 50%;"></p>
</li>
<li><p>Process “context” must be swapped</p>
</li>
</ul>
<h3 id="2-3-Threads-and-Goroutines"><a href="#2-3-Threads-and-Goroutines" class="headerlink" title="2.3 Threads and Goroutines"></a>2.3 Threads and Goroutines</h3><h5 id="Threads-vs-Processes"><a href="#Threads-vs-Processes" class="headerlink" title="Threads vs Processes"></a>Threads vs Processes</h5><ul>
<li>Threads share some context</li>
<li>Many threads can exist in one process</li>
<li>OS schedules threads rather than proccesses </li>
</ul>
<p><img src="https://pomo-blog.oss-cn-shenzhen.aliyuncs.com/article/290.png" style="zoom: 33%;"></p>
<h5 id="Goroutines"><a href="#Goroutines" class="headerlink" title="Goroutines"></a>Goroutines</h5><ul>
<li>Like a thread in Go</li>
<li>Many Goroutines execute  within a single OS thread</li>
</ul>
<p><img src="https://pomo-blog.oss-cn-shenzhen.aliyuncs.com/article/291.png" style="zoom: 33%;"></p>
<h5 id="Go-Runtime-Scheduler"><a href="#Go-Runtime-Scheduler" class="headerlink" title="Go Runtime Scheduler"></a>Go Runtime Scheduler</h5><ul>
<li>Schedules goroutines inside an OS thread</li>
<li>Like a little OS inside a single OS thread</li>
<li><strong>Logical processor</strong> is mapped to a thread</li>
</ul>
<p><img src="https://pomo-blog.oss-cn-shenzhen.aliyuncs.com/article/292.png" style="zoom:33%;"></p>
<h3 id="2-4-Interleavings"><a href="#2-4-Interleavings" class="headerlink" title="2.4 Interleavings"></a>2.4 Interleavings</h3><ul>
<li>Order of executive within a task is known</li>
<li>Order of executive between concurrent tasks is unknown</li>
<li><p>Interleaving of instructions between tasks is unknown</p>
</li>
<li><p>Many interleavings are possible</p>
</li>
<li>Must consider all possibilities</li>
<li>Ordering is <strong>non-deterministic</strong></li>
</ul>
<h3 id="2-5-Race-Conditions"><a href="#2-5-Race-Conditions" class="headerlink" title="2.5 Race Conditions"></a>2.5 Race Conditions</h3><ul>
<li>Outcome depends on non-deterministic ordering</li>
<li>Races occur due to <strong>communication</strong></li>
</ul>
<h3 id="2-6-Communication-Between-Tasks"><a href="#2-6-Communication-Between-Tasks" class="headerlink" title="2.6 Communication Between Tasks"></a>2.6 Communication Between Tasks</h3><ul>
<li>Threads are largely independent but not completely independent</li>
<li>Web server, one thread per client</li>
</ul>
<p><img src="https://pomo-blog.oss-cn-shenzhen.aliyuncs.com/article/293.png" style="zoom: 50%;"></p>
<ul>
<li>Image processing, 1 thread per pixel block</li>
</ul>
<p><img src="https://pomo-blog.oss-cn-shenzhen.aliyuncs.com/article/294.png" style="zoom: 33%;"></p>
<h2 id="3-Threads-in-Go"><a href="#3-Threads-in-Go" class="headerlink" title="3. Threads in Go"></a>3. Threads in Go</h2><h3 id="3-1-Goroutines"><a href="#3-1-Goroutines" class="headerlink" title="3.1 Goroutines"></a>3.1 Goroutines</h3><h5 id="Creating-a-Goroutine"><a href="#Creating-a-Goroutine" class="headerlink" title="Creating a Goroutine"></a>Creating a Goroutine</h5><ul>
<li>One goroutine is created automatically to execute the main()</li>
<li>Other goroutines are created using the <strong>go</strong> keyword</li>
</ul>
<p><img src="https://pomo-blog.oss-cn-shenzhen.aliyuncs.com/article/295.png" style="zoom: 25%;"></p>
<h5 id="Exiting-a-Goroutine"><a href="#Exiting-a-Goroutine" class="headerlink" title="Exiting a Goroutine"></a>Exiting a Goroutine</h5><ul>
<li>A goroutine exits <strong>when its code is complete</strong></li>
<li><strong>When the main goroutine is complete</strong>, all other goroutines exit</li>
<li><p>A goroutine may not complete its execution because main completes early</p>
</li>
<li><p>Adding a delay to wait for a goroutine is <strong>bad</strong>, because timing assumptions may be wrong and timing is nondeterministic</p>
</li>
<li>Need formal <strong>synchronization</strong> constructs</li>
</ul>
<h3 id="3-2-Basic-Synchronization"><a href="#3-2-Basic-Synchronization" class="headerlink" title="3.2 Basic Synchronization"></a>3.2 Basic Synchronization</h3><ul>
<li><p>Using <strong>global events</strong> whose execution is viewed by all threads, simultaneously</p>
</li>
<li><p>Example:</p>
<p><img src="https://pomo-blog.oss-cn-shenzhen.aliyuncs.com/article/296.png" style="zoom:50%;"></p>
<ul>
<li>Global event is viewed by all tasks at the same time</li>
<li>Print must occur after update of x</li>
<li>Synchronization is used to restrict bad interleavings</li>
<li>In this case, synchronization reduces performance and efficiency. It’s bad, but it’s necessary here.</li>
</ul>
</li>
</ul>
<h3 id="3-3-Wait-Groups"><a href="#3-3-Wait-Groups" class="headerlink" title="3.3 Wait Groups"></a>3.3 Wait Groups</h3><h5 id="Sync-WaitGroup"><a href="#Sync-WaitGroup" class="headerlink" title="Sync WaitGroup"></a>Sync WaitGroup</h5><ul>
<li>Sync package contains functions to synchronize between goroutines</li>
<li><p><strong>sync.WaitGroup</strong> forces a goroutine to wait for other goroutines</p>
</li>
<li><p>Contains an internal counter</p>
<ul>
<li>Increment counter for each goroutine to wait for</li>
<li>Decrement counter when each goroutine completes</li>
<li>Waiting goroutine cannot continue until counter is 0</li>
</ul>
</li>
</ul>
<h5 id="Using-WaitGroup"><a href="#Using-WaitGroup" class="headerlink" title="Using WaitGroup"></a>Using WaitGroup</h5><p><img src="https://pomo-blog.oss-cn-shenzhen.aliyuncs.com/article/297.png" style="zoom: 50%;"></p>
<ul>
<li><code>Add()</code>  increments the counter</li>
<li><code>Done()</code> decrements the counter</li>
<li><code>Wait()</code> blocks until counter == 0</li>
</ul>
<h5 id="WaitGroup-Example"><a href="#WaitGroup-Example" class="headerlink" title="WaitGroup Example"></a>WaitGroup Example</h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">foo</span><span class="params">(wg *sync.WaitGroup)</span></span> &#123;</span><br><span class="line">  fmt.Printf(<span class="string">"New routine"</span>)</span><br><span class="line">  wg.Done()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">  <span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line">  wg.Add(<span class="number">1</span>)</span><br><span class="line">  <span class="keyword">go</span> foo(&amp;wg)</span><br><span class="line">  wg.Wait()</span><br><span class="line">  fmt.Printf(<span class="string">"Main routine"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="3-4-Communication"><a href="#3-4-Communication" class="headerlink" title="3.4 Communication"></a>3.4 Communication</h3><h5 id="Goroutine-Communication"><a href="#Goroutine-Communication" class="headerlink" title="Goroutine Communication"></a>Goroutine Communication</h5><ul>
<li>Goroutines usually work together to perform a bigger task</li>
<li>Often need to send data to collaborate</li>
<li>Example: Find the product of 4 integers<ul>
<li>Make 2 goroutines, each multiplies a pair</li>
<li>Main goroutine multiplies the 2 results</li>
<li>Need to send ints from main routine to the two sub-routines</li>
<li>Need to send results from sub-routines back to main routine</li>
</ul>
</li>
</ul>
<h5 id="Channels"><a href="#Channels" class="headerlink" title="Channels"></a>Channels</h5><ul>
<li>Transfer data between goroutines</li>
<li>Channels are typed</li>
<li>Use <code>make()</code> to create a channel</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">c := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>Send and  receive data using the <code>&lt;-</code> operator</li>
<li>Send data on a channel</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">c &lt;- <span class="number">3</span></span><br></pre></td></tr></table></figure>
<ul>
<li>Receive data from a channel</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">x := &lt;- c</span><br></pre></td></tr></table></figure>
<ul>
<li>Channel example:</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">prod</span><span class="params">(v1 <span class="keyword">int</span>, v2 <span class="keyword">int</span>, c <span class="keyword">chan</span> <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">  c &lt;- v1 * v2</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">  c := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</span><br><span class="line">  <span class="keyword">go</span> prod(<span class="number">1</span>, <span class="number">2</span>, c)</span><br><span class="line">  <span class="keyword">go</span> prod(<span class="number">3</span>, <span class="number">4</span>, c)</span><br><span class="line">  a := &lt;- c</span><br><span class="line">  b := &lt;- c</span><br><span class="line">  fmt.Println(a * b)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="3-5-Blocking-in-Channels"><a href="#3-5-Blocking-in-Channels" class="headerlink" title="3.5 Blocking in Channels"></a>3.5 Blocking in Channels</h3><h5 id="Unbuffered-Channel"><a href="#Unbuffered-Channel" class="headerlink" title="Unbuffered Channel"></a>Unbuffered Channel</h5><ul>
<li>Unbuffered channels cannot hold data in transit<ul>
<li>Default is unbuffered</li>
</ul>
</li>
<li>Sending blocks until data is received</li>
<li>Receiving blocks until data is sent</li>
</ul>
<h5 id="Blocking-and-Synchronization"><a href="#Blocking-and-Synchronization" class="headerlink" title="Blocking and Synchronization"></a>Blocking and Synchronization</h5><ul>
<li>Channel communication is synchronous</li>
<li>Blocking is the same as waiting for communication</li>
<li>Receiving and ignoring the result is the same as a <code>Wait()</code></li>
</ul>
<h3 id="3-6-Buffered-Channels"><a href="#3-6-Buffered-Channels" class="headerlink" title="3.6 Buffered Channels"></a>3.6 Buffered Channels</h3><h5 id="Channel-Capacity"><a href="#Channel-Capacity" class="headerlink" title="Channel Capacity"></a>Channel Capacity</h5><ul>
<li>Channels can contain a limited number of objects<ul>
<li>Default size 0(unbuffered)</li>
</ul>
</li>
<li>Capacity is the number of objects it can hold in transit</li>
<li>Optional argument to <code>make()</code> defines channel capacity</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">c := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">3</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>Sending only blocks if <strong>buffer is full</strong></li>
<li>Receiving only blocks if <strong>buffer is empty</strong></li>
</ul>
<h5 id="Channel-Blocking-Receive"><a href="#Channel-Blocking-Receive" class="headerlink" title="Channel Blocking, Receive"></a>Channel Blocking, Receive</h5><ul>
<li>Channel with capacity 1</li>
</ul>
<p><img src="https://pomo-blog.oss-cn-shenzhen.aliyuncs.com/article/298.png" style="zoom: 33%;"></p>
<ul>
<li>First receive blocks until send occurs</li>
<li>Second receive blocks forever</li>
</ul>
<h5 id="Channel-Blocking-Send"><a href="#Channel-Blocking-Send" class="headerlink" title="Channel Blocking, Send"></a>Channel Blocking, Send</h5><p><img src="https://pomo-blog.oss-cn-shenzhen.aliyuncs.com/article/299.png" style="zoom: 33%;"></p>
<ul>
<li>Second send blocks until receive is done</li>
<li>Receive can block until first send is done</li>
</ul>
<h5 id="Use-of-Buffering"><a href="#Use-of-Buffering" class="headerlink" title="Use of Buffering"></a>Use of Buffering</h5><ul>
<li>Sender and receiver do not need to operate at exactly the same speed</li>
</ul>
<p><img src="https://pomo-blog.oss-cn-shenzhen.aliyuncs.com/article/300.png" style="zoom: 33%;"></p>
<ul>
<li>Speed mismatch is acceptable</li>
</ul>
<h2 id="4-Synchronized-Communication"><a href="#4-Synchronized-Communication" class="headerlink" title="4. Synchronized Communication"></a>4. Synchronized Communication</h2><h3 id="4-1-Blocking-on-Channels"><a href="#4-1-Blocking-on-Channels" class="headerlink" title="4.1 Blocking on Channels"></a>4.1 Blocking on Channels</h3><h5 id="Iterating-Through-a-Channel"><a href="#Iterating-Through-a-Channel" class="headerlink" title="Iterating Through a Channel"></a>Iterating Through a Channel</h5><ul>
<li>Common to iteratively read from a channel</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i := <span class="keyword">range</span> c &#123;</span><br><span class="line">  fmt.Println(i)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>Continues to read from channel c</li>
<li>One iteration each time a new value is received</li>
<li>i is assigned to the read value</li>
<li>Iterates when sender calls <code>close(c)</code></li>
</ul>
<h5 id="Receiving-from-Multiple-Goroutines"><a href="#Receiving-from-Multiple-Goroutines" class="headerlink" title="Receiving from Multiple Goroutines"></a>Receiving from Multiple Goroutines</h5><ul>
<li>Multiple channels may be used to receive from multiple sources</li>
</ul>
<p><img src="https://pomo-blog.oss-cn-shenzhen.aliyuncs.com/article/301.png" style="zoom: 33%;"></p>
<ul>
<li>Data from both sources may be needed</li>
<li>Read sequentially</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">a := &lt;- c1</span><br><span class="line">b := &lt;- c2</span><br><span class="line">fmt.Println(a*b)</span><br></pre></td></tr></table></figure>
<h5 id="Select-Statement"><a href="#Select-Statement" class="headerlink" title="Select Statement"></a>Select Statement</h5><ul>
<li>May have a choice of which data to use<ul>
<li>i.e. First-come first-served</li>
</ul>
</li>
<li>Use the <code>select</code> statement to wait on the first data from a set of channels</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> &#123;</span><br><span class="line">  <span class="keyword">case</span> a = &lt;- c1:</span><br><span class="line">  	fmt.Println(a)</span><br><span class="line">  <span class="keyword">case</span> b = &lt;- c2:</span><br><span class="line">  	fmt.Println(b)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="4-2-Select"><a href="#4-2-Select" class="headerlink" title="4.2 Select"></a>4.2 Select</h3><h5 id="Select-Send-or-Receive"><a href="#Select-Send-or-Receive" class="headerlink" title="Select Send or Receive"></a>Select Send or Receive</h5><ul>
<li>May select either send or receive operations</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> &#123;</span><br><span class="line">  <span class="keyword">case</span> a = &lt;- inchan:</span><br><span class="line">  	fmt.Println(<span class="string">"Received a"</span>)</span><br><span class="line">  <span class="keyword">case</span> outchan &lt;- b:</span><br><span class="line">  	fmt.Println(<span class="string">"Sent b"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="Select-with-an-Abort-channel"><a href="#Select-with-an-Abort-channel" class="headerlink" title="Select with an Abort channel"></a>Select with an Abort channel</h5><ul>
<li>Use select with a <strong>separate abort channel</strong></li>
<li>May want to receive data until an <strong>abort signal</strong> is received</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">  <span class="keyword">select</span> &#123;</span><br><span class="line">    <span class="keyword">case</span> a = &lt;- c:</span><br><span class="line">    	fmt.Println(a)</span><br><span class="line">    <span class="keyword">case</span> &lt;-abort:</span><br><span class="line">    	<span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="Default-Select"><a href="#Default-Select" class="headerlink" title="Default Select"></a>Default Select</h5><ul>
<li>May want a default operation to avoid blocking</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> &#123;</span><br><span class="line">  <span class="keyword">case</span> a = &lt;- c1:</span><br><span class="line">  	fmt.Println(a)</span><br><span class="line">  <span class="keyword">case</span> b = &lt;- c2:</span><br><span class="line">  	fmt.Println(b)</span><br><span class="line">  <span class="keyword">default</span>:</span><br><span class="line">  	fmt.Println(<span class="string">"nop"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="4-3-Mutual-Exclution"><a href="#4-3-Mutual-Exclution" class="headerlink" title="4.3 Mutual Exclution"></a>4.3 Mutual Exclution</h3><h5 id="Goroutines-Sharing-Variables"><a href="#Goroutines-Sharing-Variables" class="headerlink" title="Goroutines Sharing Variables"></a>Goroutines Sharing Variables</h5><ul>
<li>Sharing variables concurrently can cause problems</li>
<li><p>Two goroutines writing to a shared variable can interfere with each other</p>
</li>
<li><p>Function can be invoked concurrently without interfering with other goroutines(<strong>Concurrency-Safe</strong>)</p>
</li>
</ul>
<h5 id="Variable-Sharing-Example"><a href="#Variable-Sharing-Example" class="headerlink" title="Variable Sharing Example"></a>Variable Sharing Example</h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> i <span class="keyword">int</span> = <span class="number">0</span></span><br><span class="line"><span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">inc</span><span class="params">()</span></span> &#123;</span><br><span class="line">  i = i + <span class="number">1</span></span><br><span class="line">  wg.Done()</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">  wg.Add(<span class="number">2</span>)</span><br><span class="line">  <span class="keyword">go</span> inc()</span><br><span class="line">  <span class="keyword">go</span> inc()</span><br><span class="line">  wg.Wait()</span><br><span class="line">  fmt.Println(i)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>Two goroutines write to i</li>
<li>i should equal 2, but this doesn’t always happen. Because there are some possible interleavings</li>
</ul>
<h5 id="Granularity-of-Concurrency"><a href="#Granularity-of-Concurrency" class="headerlink" title="Granularity of Concurrency"></a>Granularity of Concurrency</h5><ul>
<li>Concurrency is at the machine code level</li>
<li>i = i + 1 might be three machine instructions</li>
</ul>
<p><img src="https://pomo-blog.oss-cn-shenzhen.aliyuncs.com/article/302.png" style="zoom: 50%;"></p>
<ul>
<li><p>Interleaving machine instructions causes unexpected problems</p>
</li>
<li><p>Interleaving machine instructions</p>
<ul>
<li><p>Both tasks read 0 for 1 value</p>
<p><img src="https://pomo-blog.oss-cn-shenzhen.aliyuncs.com/article/303.png" style="zoom: 25%;"></p>
</li>
</ul>
</li>
</ul>
<h3 id="4-4-Mutex"><a href="#4-4-Mutex" class="headerlink" title="4.4 Mutex"></a>4.4 Mutex</h3><h5 id="Correct-Sharing"><a href="#Correct-Sharing" class="headerlink" title="Correct Sharing"></a>Correct Sharing</h5><ul>
<li>Don‘t let 2 goroutines write to a shared variable at the same time!</li>
<li>Need to restrict possible interleavings</li>
<li>Access to shared variables cannot be interleaved</li>
<li>Code segements in different goroutines which cannot execute concurrently(<strong>Mutual Exclusion</strong>)</li>
<li>Writing to shared variables should be mutually exclusive</li>
</ul>
<h5 id="Sync-Mutex"><a href="#Sync-Mutex" class="headerlink" title="Sync.Mutex"></a>Sync.Mutex</h5><ul>
<li>A Mutex ensures mutual exclusion</li>
<li>Uses a <strong>binary semaphore</strong></li>
</ul>
<p><img src="https://pomo-blog.oss-cn-shenzhen.aliyuncs.com/article/304.png" style="zoom: 33%;"></p>
<ul>
<li>Flag up - shared variable is in use</li>
<li>Flag down - shared variable is available</li>
</ul>
<h3 id="4-5-Mutex-Methods"><a href="#4-5-Mutex-Methods" class="headerlink" title="4.5 Mutex Methods"></a>4.5 Mutex Methods</h3><p>#####Sync.Mutex Methods</p>
<ul>
<li><code>Lock()</code> method puts the flag up<ul>
<li>Shared variable in use</li>
</ul>
</li>
<li><p>If lock is already taken by a goroutine, <code>Lock()</code> blocks until the flag is put down</p>
</li>
<li><p><code>Unlock()</code> method puts the flag down</p>
<ul>
<li>Done using shared variable</li>
</ul>
</li>
<li>When <code>Unlock()</code> is called, a blocked <code>Lock()</code> can proceed</li>
</ul>
<h5 id="Using-Sync-Mutex"><a href="#Using-Sync-Mutex" class="headerlink" title="Using Sync.Mutex"></a>Using Sync.Mutex</h5><ul>
<li>Increment operation is now mutually exclutive</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> i <span class="keyword">int</span> = <span class="number">0</span></span><br><span class="line"><span class="keyword">var</span> mut sync.Mutex</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">inc</span><span class="params">()</span></span> &#123;</span><br><span class="line">  mut.Lock()</span><br><span class="line">  i = i + <span class="number">1</span></span><br><span class="line">  mut.Unlock()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="4-6-Once-Synchronization"><a href="#4-6-Once-Synchronization" class="headerlink" title="4.6 Once Synchronization"></a>4.6 Once Synchronization</h3><h5 id="Synchronous-Initialization"><a href="#Synchronous-Initialization" class="headerlink" title="Synchronous Initialization"></a>Synchronous Initialization</h5><ul>
<li>Initialization<ul>
<li>must happen once</li>
<li>must happen before everything else</li>
</ul>
</li>
<li>How do you perform initialization with multiple goroutines?</li>
<li>Could perform initialization before starting the goroutines?</li>
</ul>
<h5 id="Sync-Once"><a href="#Sync-Once" class="headerlink" title="Sync.Once"></a>Sync.Once</h5><ul>
<li>Has one method, <code>once.Do(f)</code></li>
<li>Function if is executed only one time<ul>
<li>Even if it is called in multiple goroutines</li>
</ul>
</li>
<li>All calls to <code>once.Do()</code> block until the first returns<ul>
<li>Ensures that initialization executes first</li>
</ul>
</li>
</ul>
<p>#####Sync.Once  Example</p>
<ul>
<li>Make two goroutines, initialization only once</li>
<li>Each goroutine executes <code>dostuff()</code></li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">  wg.Add(<span class="number">2</span>)</span><br><span class="line">  <span class="keyword">go</span> dostuff()</span><br><span class="line">  <span class="keyword">go</span> dostuff()</span><br><span class="line">  wg.Wait()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><p>Using Sync.Once</p>
<ul>
<li><p><code>setup()</code> should execute only once</p>
</li>
<li><p>“hello” should not print until <code>setup()</code> returns</p>
</li>
<li><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> on sync.Once</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">setup</span><span class="params">()</span></span> &#123;</span><br><span class="line">  fmt.Println(<span class="string">"Init"</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">dostuff</span><span class="params">()</span></span> &#123;</span><br><span class="line">  on.Do(setup)</span><br><span class="line">  fmt.Println(<span class="string">"hello"</span>)</span><br><span class="line">  wg.Done()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>Execution Result</p>
<ul>
<li><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Init        <span class="comment">//Result of setup()</span></span><br><span class="line">hello       <span class="comment">//Result of one goroutine</span></span><br><span class="line">hello       <span class="comment">//Result of the other goroutine</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><code>Init</code> appears only once</p>
</li>
<li><p><code>Init</code> appears before <code>hello</code> is printed</p>
</li>
</ul>
</li>
</ul>
<h3 id="4-7-Deadlock"><a href="#4-7-Deadlock" class="headerlink" title="4.7 Deadlock"></a>4.7 Deadlock</h3><h5 id="Synchronization-Dependencies"><a href="#Synchronization-Dependencies" class="headerlink" title="Synchronization Dependencies"></a>Synchronization Dependencies</h5><ul>
<li>Synchronization causes the execution of different goroutines to depend on each other</li>
</ul>
<p><img src="https://pomo-blog.oss-cn-shenzhen.aliyuncs.com/article/305.png" style="zoom: 33%;"></p>
<ul>
<li>G2 cannot continue until G1 does something</li>
</ul>
<h5 id="Deadlock"><a href="#Deadlock" class="headerlink" title="Deadlock"></a>Deadlock</h5><ul>
<li><strong>Circular dependencies</strong> cause all involved goroutines to block<ul>
<li>G1 waits for G2</li>
<li>G2 waits for G1</li>
</ul>
</li>
<li>Can be caused by waiting on channels</li>
</ul>
<h5 id="Deadlock-Example"><a href="#Deadlock-Example" class="headerlink" title="Deadlock Example"></a>Deadlock Example</h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">dostuff</span><span class="params">(c1 <span class="keyword">chan</span> <span class="keyword">int</span>, c2 <span class="keyword">chan</span> <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">  &lt;- c1</span><br><span class="line">  c2 &lt;- <span class="number">1</span></span><br><span class="line">  wg.Done()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>Read from first channel<ul>
<li>Wait for write onto first channel</li>
</ul>
</li>
<li>Write to second channel<ul>
<li>Wait for read from second channel</li>
</ul>
</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">  ch1 := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</span><br><span class="line">  ch2 := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</span><br><span class="line">  wg.Add(<span class="number">2</span>)</span><br><span class="line">  <span class="keyword">go</span> dostuff(ch1, ch2)</span><br><span class="line">  <span class="keyword">go</span> dostuff(ch2, ch1)</span><br><span class="line">  wg.Wait()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>dostuff()</code> argument order is swapped</li>
<li>Each goroutine blocked on channel read</li>
</ul>
<h5 id="Deadlock-Detection"><a href="#Deadlock-Detection" class="headerlink" title="Deadlock Detection"></a>Deadlock Detection</h5><ul>
<li>Golang runtime automatically detects when all goroutines are deadlocked</li>
</ul>
<p><img src="https://pomo-blog.oss-cn-shenzhen.aliyuncs.com/article/306.png" style="zoom: 50%;"></p>
<ul>
<li>Cannot detect when a subset of goroutines are deadlocked</li>
</ul>
<h3 id="4-8-Dining-Philosophers"><a href="#4-8-Dining-Philosophers" class="headerlink" title="4.8 Dining Philosophers"></a>4.8 Dining Philosophers</h3><h5 id="Dining-Philosophers-Problem"><a href="#Dining-Philosophers-Problem" class="headerlink" title="Dining Philosophers Problem"></a>Dining Philosophers Problem</h5><ul>
<li><p>Classical problem involvingconcurrency and synchronization</p>
</li>
<li><p>Problem:</p>
<ul>
<li>5 philosophers sitting at a round table</li>
<li>1 chopstick is placed between each adjacent pair</li>
<li>Want to eat rice from their plate, but needs two chopsticks</li>
<li>Only one philosopher can hold a chopstick at a time</li>
<li>Not enough chopsticks for everyone to eat at once</li>
</ul>
<p><img src="https://pomo-blog.oss-cn-shenzhen.aliyuncs.com/article/307.png" style="zoom:50%;"></p>
</li>
<li><p>Each chopstick is a mutex</p>
</li>
<li><p>Each philosopher is associated with a goroutine and two chopsticks</p>
</li>
<li><p>Chopsticks and Philosophers</p>
<ul>
<li><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Chops <span class="keyword">struct</span> &#123;</span><br><span class="line">  sync.Mutex</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Philo <span class="keyword">struct</span> &#123;</span><br><span class="line">  leftCS, rightCS *Chops</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>Philosopher Eat Method</p>
<ul>
<li><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span><span class="params">(p Philo)</span> <span class="title">eat</span><span class="params">()</span></span> &#123;</span><br><span class="line">  <span class="keyword">for</span> &#123;</span><br><span class="line">    p.leftCS.Lock()</span><br><span class="line">    p.rightCS.Lock()</span><br><span class="line">    </span><br><span class="line">    fmt.Println(<span class="string">"eating"</span>)</span><br><span class="line">    </span><br><span class="line">    p.rightCS.Unlock()</span><br><span class="line">    p.leftCS.Unlock()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>Initialization in Main</p>
<ul>
<li><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">CSticks := <span class="built_in">make</span>([]*Chops, <span class="number">5</span>)</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">5</span>; i++ &#123;</span><br><span class="line">  CSticks[i] = <span class="built_in">new</span>(ChopS)</span><br><span class="line">&#125;</span><br><span class="line">philos := <span class="built_in">make</span>([]*Philo, <span class="number">5</span>)</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">5</span>; i++ &#123;</span><br><span class="line">  philos[i] = &amp;Philo&#123;Csticks[i], Csticks[(i + <span class="number">1</span>) % <span class="number">5</span>]&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Initialize chopsticks and philosophers</p>
</li>
<li><p>Notice <code>(i + 1) % 5]</code> </p>
</li>
</ul>
</li>
<li><p>Start the Dining in Main</p>
<ul>
<li><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">5</span>; i++ &#123;</span><br><span class="line">  <span class="keyword">go</span> philos[i].eat()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Start each philosopher eating</p>
</li>
<li><p>Would also need to wait in the main</p>
</li>
</ul>
</li>
<li><p>Deadlock Problem</p>
<ul>
<li><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">p.leftCS.Lock()</span><br><span class="line">p.rightCS.Lock()</span><br><span class="line">fmt.Println(<span class="string">"eating"</span>)</span><br><span class="line">p.leftCS.Unlock()</span><br><span class="line">p.rightCS.Unlock()</span><br></pre></td></tr></table></figure>
</li>
<li><p>All philosophers might lock their left chopsticks concurrently</p>
</li>
<li><p>All chopsticks would be locked</p>
</li>
<li><p>Noone can lock their right chopsticks</p>
</li>
</ul>
</li>
<li><p>Deadlock Solution</p>
<ul>
<li><p>Each philosopher <strong>picks up lowest numbered chopstick first</strong></p>
</li>
<li><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">5</span>; i++ &#123;</span><br><span class="line">  <span class="keyword">if</span> i &lt; (i + <span class="number">1</span>) % <span class="number">5</span> &#123;</span><br><span class="line">    philos[i] = &amp;Philo&#123;Csticks[i], Csticks[(i + <span class="number">1</span>) % <span class="number">5</span>]&#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    philos[i] = &amp;Philo&#123;Csticks[(i + <span class="number">1</span>) % <span class="number">5</span>], Csticks[i]&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Philosopher 4 picks up chopstick 0 before chopstick 4</p>
</li>
<li><p>Philosopher 4 blocks allowing philosopher 3 to eat</p>
</li>
<li><p>No deadlock, but philosopher 4 may starve</p>
</li>
</ul>
</li>
</ul>
</div><div class="tags"><a href="/tags/go/">go</a></div><div class="post-nav"><a class="pre" href="/2020/06/02/Go-struct-类型Channel/">Go struct{}类型Channel</a><a class="next" href="/2020/04/22/Docker搭建FTP/">Docker搭建FTP</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="search-form"><input id="local-search-input" placeholder="Search" type="text" name="q" results="0"><div id="local-search-result"></div></div></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/ElasticSearch/">ElasticSearch</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python/">Python</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/blog/">blog</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/data/">data</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/git/">git</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/go/">go</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/java/">java</a><span class="category-list-count">19</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/java/Redis/">Redis</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/java/jsp/">jsp</a><span class="category-list-count">2</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/java/jsp/Servlet/">Servlet</a><span class="category-list-count">1</span></li></ul></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/linux/">linux</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/mysql/">mysql</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/projects/">projects</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/web/">web</a><span class="category-list-count">7</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/web/docker/">docker</a><span class="category-list-count">2</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/工具/">工具</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/微信小程序/">微信小程序</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/操作系统/">操作系统</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/算法/">算法</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/设计模式/">设计模式</a><span class="category-list-count">1</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/jQuery/" style="font-size: 15px;">jQuery</a> <a href="/tags/ElasticSearch/" style="font-size: 15px;">ElasticSearch</a> <a href="/tags/Eclipse/" style="font-size: 15px;">Eclipse</a> <a href="/tags/go/" style="font-size: 15px;">go</a> <a href="/tags/http/" style="font-size: 15px;">http</a> <a href="/tags/java/" style="font-size: 15px;">java</a> <a href="/tags/jsp/" style="font-size: 15px;">jsp</a> <a href="/tags/JavaWeb/" style="font-size: 15px;">JavaWeb</a> <a href="/tags/rpc/" style="font-size: 15px;">rpc</a> <a href="/tags/git/" style="font-size: 15px;">git</a> <a href="/tags/vim/" style="font-size: 15px;">vim</a> <a href="/tags/linux/" style="font-size: 15px;">linux</a> <a href="/tags/Python/" style="font-size: 15px;">Python</a> <a href="/tags/七牛云/" style="font-size: 15px;">七牛云</a> <a href="/tags/CDN/" style="font-size: 15px;">CDN</a> <a href="/tags/blog/" style="font-size: 15px;">blog</a> <a href="/tags/RSS/" style="font-size: 15px;">RSS</a> <a href="/tags/hexo/" style="font-size: 15px;">hexo</a> <a href="/tags/ftp/" style="font-size: 15px;">ftp</a> <a href="/tags/设计模式/" style="font-size: 15px;">设计模式</a> <a href="/tags/projects/" style="font-size: 15px;">projects</a> <a href="/tags/jre/" style="font-size: 15px;">jre</a> <a href="/tags/jdk/" style="font-size: 15px;">jdk</a> <a href="/tags/微信小程序/" style="font-size: 15px;">微信小程序</a> <a href="/tags/Servlet/" style="font-size: 15px;">Servlet</a> <a href="/tags/IO/" style="font-size: 15px;">IO</a> <a href="/tags/Hadoop/" style="font-size: 15px;">Hadoop</a> <a href="/tags/hive/" style="font-size: 15px;">hive</a> <a href="/tags/集合/" style="font-size: 15px;">集合</a> <a href="/tags/Spring/" style="font-size: 15px;">Spring</a> <a href="/tags/操作系统/" style="font-size: 15px;">操作系统</a> <a href="/tags/数组/" style="font-size: 15px;">数组</a> <a href="/tags/String/" style="font-size: 15px;">String</a> <a href="/tags/算法/" style="font-size: 15px;">算法</a> <a href="/tags/mysql/" style="font-size: 15px;">mysql</a> <a href="/tags/Redis/" style="font-size: 15px;">Redis</a> <a href="/tags/JVM/" style="font-size: 15px;">JVM</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2020/07/15/Hive/">Hive</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/07/15/Hadoop核心组件/">Hadoop核心组件</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/06/05/Docker安装ES及IK分词器/">Docker安装ES相关</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/06/03/Go-数组和切片/">Go 数组、字符串和切片</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/06/02/Go-struct-类型Channel/">Go struct{}类型Channel</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/05/16/Concurrency-in-Go/">Concurrency in Go</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/04/22/Docker搭建FTP/">Docker搭建FTP</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/10/30/Go-Garbage-Collection/">Go Garbage Collection</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/10/20/git/">git</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/10/18/ElasticSearch/">ElasticSearch</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="https://github.com/pomo16" title="我的Github" target="_blank">我的Github</a><ul></ul><a href="https://blog.csdn.net/pomo16" title="我的CSDN" target="_blank">我的CSDN</a><ul></ul><a href="http://pomo16.coding.me/" title="我的老博客(荒废已久)" target="_blank">我的老博客(荒废已久)</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2020 <a href="/." rel="nofollow">Atlantis.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.css"><script type="text/javascript" src="/js/search.js?v=0.0.0"></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
   search_path = 'search.xml';
}
var path = '/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script><!-- 添加点击爱心功能--><script type="text/javascript" src="/js/clicklove.js?v=0.0.0"></script></div></body></html>